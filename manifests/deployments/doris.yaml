---
apiVersion: v1
kind: Service
metadata:
  name: doris-fe
  namespace: default
spec:
  type: ClusterIP
  ports:
    - port: 9030
      targetPort: 9030
      name: query
    - port: 8030
      targetPort: 8030
      name: http
  selector:
    app: doris-fe
---
apiVersion: v1
kind: Service
metadata:
  name: doris-be
  namespace: default
spec:
  type: ClusterIP
  ports:
    - port: 9060
      targetPort: 9060
      name: heartbeat
    - port: 8040
      targetPort: 8040
      name: webserver
  selector:
    app: doris-be
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: doris-fe
  namespace: default
  labels:
    app: doris-fe
spec:
  serviceName: doris-fe
  replicas: 1
  selector:
    matchLabels:
      app: doris-fe
  template:
    metadata:
      labels:
        app: doris-fe
    spec:
      initContainers:
      - name: wait-for-iceberg-rest
        image: busybox:1.36
        command:
          - sh
          - -c
          - |
            echo "Waiting for Iceberg REST catalog to be ready..."
            until nc -z iceberg-rest.default.svc.cluster.local 8181; do
              echo "Iceberg REST not ready, waiting..."
              sleep 5
            done
            echo "Iceberg REST catalog is ready!"
            sleep 5
      containers:
      - name: doris-fe
        image: apache/doris:4.0.3-all-slim
        command: ["/bin/bash"]
        args:
          - -c
          - |
            set -e
            export priority_networks=10.244.0.0/16
            cd /opt/apache-doris/fe
            ./bin/start_fe.sh --daemon
            while true; do
              if ! pgrep -f "PaloFe" > /dev/null; then
                echo "FE process died, exiting"
                exit 1
              fi
              sleep 10
            done
        ports:
        - containerPort: 9030
          name: query
        - containerPort: 8030
          name: http
        - containerPort: 9010
          name: edit-log
        env:
        - name: FE_SERVERS
          value: "fe1:doris-fe-0.doris-fe.default.svc.cluster.local:9010"
        - name: FE_ID
          value: "1"
        volumeMounts:
        - name: fe-data
          mountPath: /opt/apache-doris/fe/doris-meta
        resources:
          requests:
            cpu: 1000m
            memory: 2Gi
          limits:
            cpu: 2000m
            memory: 4Gi
        livenessProbe:
          tcpSocket:
            port: 9030
          initialDelaySeconds: 90
          periodSeconds: 20
          timeoutSeconds: 10
          failureThreshold: 6
        readinessProbe:
          tcpSocket:
            port: 9030
          initialDelaySeconds: 60
          periodSeconds: 10
          timeoutSeconds: 10
          failureThreshold: 12
  volumeClaimTemplates:
  - metadata:
      name: fe-data
    spec:
      accessModes: [ "ReadWriteOnce" ]
      resources:
        requests:
          storage: 5Gi
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: doris-be
  namespace: default
  labels:
    app: doris-be
spec:
  serviceName: doris-be
  replicas: 1
  selector:
    matchLabels:
      app: doris-be
  template:
    metadata:
      labels:
        app: doris-be
    spec:
      initContainers:
      - name: wait-for-fe
        image: busybox:1.36
        command:
          - sh
          - -c
          - |
            echo "Waiting for Doris FE to be ready..."
            until nc -z doris-fe.default.svc.cluster.local 9030; do
              echo "Doris FE not ready, waiting..."
              sleep 5
            done
            echo "Doris FE is ready!"
            sleep 15
      containers:
      - name: doris-be
        image: apache/doris:4.0.3-all-slim
        securityContext:
          privileged: true
        command: ["/bin/bash"]
        args:
          - -c
          - |
            set -x
            echo "=== Starting Doris BE initialization ==="
            POD_IP=$(hostname -i)
            echo "Pod IP: $POD_IP"
            echo "priority_networks = 10.244.0.0/16" >> /opt/apache-doris/be/conf/be.conf
            # Kind/local dev often runs with host swap enabled; Doris startup script exits if swap is detected.
            # We skip these preflight checks via env (SKIP_CHECK_ULIMIT=true) instead of patching the image on startup.
            ulimit -n 655350 || true
            echo "=== Changed directory to BE home ==="
            cd /opt/apache-doris/be || { echo "Failed to cd to BE directory"; exit 1; }
            echo "=== Starting Doris BE daemon ==="
            ./bin/start_be.sh --daemon || { echo "Failed to start BE"; cat log/be.out 2>&1; exit 1; }
            echo "=== Waiting for BE to initialize ==="
            sleep 20
            # Check if BE started
            if [ ! -f bin/be.pid ]; then
              echo "ERROR: BE PID file not created"
              cat log/be.out 2>&1 || echo "No be.out log found"
              exit 1
            fi
            echo "BE PID: $(cat bin/be.pid)"
            # Register BE with FE
            echo "=== Registering BE with FE ==="
            mysql -h doris-fe.default.svc.cluster.local -P 9030 -uroot --skip-column-names -e "ALTER SYSTEM ADD BACKEND '${POD_IP}:9050';" || echo "BE registration failed or already registered"
            # Monitor BE process
            echo "=== Monitoring BE process ==="
            while true; do
              if [ ! -f bin/be.pid ] || ! kill -0 $(cat bin/be.pid) 2>/dev/null; then
                echo "BE process died, checking logs..."
                tail -100 log/be.out 2>&1 || echo "No logs available"
                exit 1
              fi
              sleep 10
            done
        ports:
        - containerPort: 9060
          name: heartbeat
        - containerPort: 8040
          name: webserver
        - containerPort: 9050
          name: be-port
        env:
        - name: FE_SERVERS
          value: "doris-fe-0.doris-fe.default.svc.cluster.local:9010"
        - name: BE_ADDR
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        - name: SKIP_CHECK_ULIMIT
          value: "true"
        volumeMounts:
        - name: be-data
          mountPath: /opt/apache-doris/be/storage
        resources:
          requests:
            cpu: 1000m
            memory: 2Gi
          limits:
            cpu: 2000m
            memory: 4Gi
        livenessProbe:
          tcpSocket:
            port: 9060
          initialDelaySeconds: 90
          periodSeconds: 20
          timeoutSeconds: 10
          failureThreshold: 6
        readinessProbe:
          tcpSocket:
            port: 9060
          initialDelaySeconds: 60
          periodSeconds: 10
          timeoutSeconds: 10
          failureThreshold: 12
  volumeClaimTemplates:
  - metadata:
      name: be-data
    spec:
      accessModes: [ "ReadWriteOnce" ]
      resources:
        requests:
          storage: 10Gi
