apiVersion: batch/v1
kind: Job
metadata:
  name: hive-metastore-init
  namespace: default
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      restartPolicy: OnFailure
      initContainers:
      - name: wait-for-postgres
        image: postgres:16
        command: ['sh', '-c', 'until pg_isready -h postgres-postgresql -U postgres; do echo waiting for postgres; sleep 2; done']
      containers:
      - name: schema-init
        image: apache/hive:4.0.0
        command: ["/bin/sh"]
        args:
          - -c
          - |
            set -e
            echo "Downloading PostgreSQL JDBC driver..."
            curl -L -o /tmp/postgresql-jdbc.jar https://jdbc.postgresql.org/download/postgresql-42.7.1.jar
            
            echo "Getting PostgreSQL password..."
            export POSTGRES_PASSWORD_VALUE=$(cat /var/run/secrets/postgres-password/postgres-password)
            
            echo "Initializing Hive Metastore schema..."
            export HADOOP_CLASSPATH=/tmp/postgresql-jdbc.jar
            export AUX_CLASSPATH=/tmp/postgresql-jdbc.jar
            
            /opt/hive/bin/schematool \
              -verbose \
              -dbType postgres \
              -driver org.postgresql.Driver \
              -url jdbc:postgresql://postgres-postgresql.default.svc.cluster.local:5432/metastore \
              -userName postgres \
              -passWord "$POSTGRES_PASSWORD_VALUE" \
              -initSchema
            
            echo "Schema initialization complete!"
        volumeMounts:
        - name: postgres-secret
          mountPath: /var/run/secrets/postgres-password
          readOnly: true
      volumes:
      - name: postgres-secret
        secret:
          secretName: postgres-postgresql
