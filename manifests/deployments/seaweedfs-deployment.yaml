apiVersion: v1
kind: Secret
metadata:
  name: seaweedfs-s3
  namespace: default
type: Opaque
stringData:
  access-key: "admin"
  secret-key: "minio_password"
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: seaweedfs-s3-config
  namespace: default
data:
  s3.json: |
    {
      "identities": [
        {
          "name": "admin",
          "credentials": [
            {
              "accessKey": "admin",
              "secretKey": "minio_password"
            }
          ],
          "actions": ["Admin"]
        }
      ]
    }
---
apiVersion: v1
kind: Service
metadata:
  name: seaweedfs-s3
  namespace: default
spec:
  type: ClusterIP
  selector:
    app: seaweedfs
  ports:
    - name: s3
      port: 8333
      targetPort: 8333
---
apiVersion: v1
kind: Service
metadata:
  name: seaweedfs-filer
  namespace: default
spec:
  type: ClusterIP
  selector:
    app: seaweedfs
  ports:
    - name: http
      port: 8888
      targetPort: 8888
    - name: grpc
      port: 18888
      targetPort: 18888
---
apiVersion: v1
kind: Service
metadata:
  name: seaweedfs-master
  namespace: default
spec:
  type: ClusterIP
  selector:
    app: seaweedfs
  ports:
    - name: master
      port: 9333
      targetPort: 9333
    - name: grpc
      port: 19333
      targetPort: 19333
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: seaweedfs
  namespace: default
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: seaweedfs
  template:
    metadata:
      labels:
        app: seaweedfs
        app.kubernetes.io/name: seaweedfs
    spec:
      initContainers:
        - name: init-seaweedfs-dirs
          image: busybox:1.36.1
          command: ["sh", "-c"]
          args:
            - |
              set -eu
              mkdir -p /data/master /data/volume
          volumeMounts:
            - name: data
              mountPath: /data
      containers:
        - name: master
          image: chrislusf/seaweedfs:3.74
          env:
            - name: POD_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP
          command: ["weed"]
          args: ["master", "-ip=$(POD_IP)", "-ip.bind=0.0.0.0", "-port=9333", "-mdir=/data/master"]
          ports:
            - containerPort: 9333
              name: master
            - containerPort: 19333
              name: master-grpc
          readinessProbe:
            tcpSocket:
              port: 9333
            initialDelaySeconds: 3
            periodSeconds: 5
            timeoutSeconds: 2
            failureThreshold: 12
          livenessProbe:
            tcpSocket:
              port: 9333
            initialDelaySeconds: 15
            periodSeconds: 10
            timeoutSeconds: 2
            failureThreshold: 6
          resources:
            requests:
              cpu: 100m
              memory: 256Mi
            limits:
              cpu: 1000m
              memory: 1Gi
          volumeMounts:
            - name: data
              mountPath: /data
        - name: volume
          image: chrislusf/seaweedfs:3.74
          env:
            - name: POD_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP
          command: ["weed"]
          args: ["volume", "-mserver=127.0.0.1:9333", "-ip=$(POD_IP)", "-ip.bind=0.0.0.0", "-port=8080", "-dir=/data/volume", "-max=50"]
          ports:
            - containerPort: 8080
              name: volume
          readinessProbe:
            tcpSocket:
              port: 8080
            initialDelaySeconds: 5
            periodSeconds: 5
            timeoutSeconds: 2
            failureThreshold: 12
          livenessProbe:
            tcpSocket:
              port: 8080
            initialDelaySeconds: 20
            periodSeconds: 10
            timeoutSeconds: 2
            failureThreshold: 6
          resources:
            requests:
              cpu: 100m
              memory: 256Mi
            limits:
              cpu: 1000m
              memory: 1Gi
          volumeMounts:
            - name: data
              mountPath: /data
        - name: filer
          image: chrislusf/seaweedfs:3.74
          env:
            - name: POD_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP
          command: ["weed"]
          args: ["filer", "-master=127.0.0.1:9333", "-ip=$(POD_IP)", "-ip.bind=0.0.0.0", "-port=8888"]
          ports:
            - containerPort: 8888
              name: filer
            - containerPort: 18888
              name: filer-grpc
          readinessProbe:
            tcpSocket:
              port: 8888
            initialDelaySeconds: 5
            periodSeconds: 5
            timeoutSeconds: 2
            failureThreshold: 12
          livenessProbe:
            tcpSocket:
              port: 8888
            initialDelaySeconds: 20
            periodSeconds: 10
            timeoutSeconds: 2
            failureThreshold: 6
          resources:
            requests:
              cpu: 100m
              memory: 256Mi
            limits:
              cpu: 1000m
              memory: 1Gi
          volumeMounts:
            - name: data
              mountPath: /data
        - name: s3
          image: chrislusf/seaweedfs:3.74
          command: ["weed"]
          args: ["s3", "-filer=127.0.0.1:8888", "-ip.bind=0.0.0.0", "-port=8333", "-config=/etc/seaweedfs/s3.json"]
          ports:
            - containerPort: 8333
              name: s3
          readinessProbe:
            tcpSocket:
              port: 8333
            initialDelaySeconds: 5
            periodSeconds: 5
            timeoutSeconds: 2
            failureThreshold: 12
          livenessProbe:
            tcpSocket:
              port: 8333
            initialDelaySeconds: 20
            periodSeconds: 10
            timeoutSeconds: 2
            failureThreshold: 6
          resources:
            requests:
              cpu: 100m
              memory: 256Mi
            limits:
              cpu: 1000m
              memory: 1Gi
          volumeMounts:
            - name: s3-config
              mountPath: /etc/seaweedfs
              readOnly: true
      volumes:
        - name: data
          emptyDir: {}
        - name: s3-config
          configMap:
            name: seaweedfs-s3-config
