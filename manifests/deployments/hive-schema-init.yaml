apiVersion: v1
kind: ConfigMap
metadata:
  name: hive-init-script
  namespace: default
data:
  init-schema.sh: |
    #!/bin/bash
    set -e
    
    export PGPASSWORD=$(cat /var/run/secrets/postgres-password/postgres-password)
    
    echo "Creating Hive Metastore tables..."
    
    # Minimal Hive Metastore schema for Iceberg
    psql -h postgres-postgresql.default.svc.cluster.local -U postgres -d metastore <<'EOF'
    -- Core metastore tables
    CREATE TABLE IF NOT EXISTS "VERSION" (
      "VER_ID" bigint NOT NULL,
      "SCHEMA_VERSION" varchar(127) NOT NULL,
      "VERSION_COMMENT" varchar(255),
      PRIMARY KEY ("VER_ID")
    );
    
    INSERT INTO "VERSION" ("VER_ID", "SCHEMA_VERSION", "VERSION_COMMENT") 
    VALUES (1, '4.0.0', 'Hive release version 4.0.0') 
    ON CONFLICT DO NOTHING;
    
    CREATE TABLE IF NOT EXISTS "CTLGS" (
      "CTLG_ID" bigint NOT NULL,
      "NAME" varchar(256),
      "DESC" varchar(4000),
      "LOCATION_URI" varchar(4000) NOT NULL,
      "CREATE_TIME" integer NOT NULL,
      PRIMARY KEY ("CTLG_ID")
    );
    
    INSERT INTO "CTLGS" ("CTLG_ID", "NAME", "DESC", "LOCATION_URI", "CREATE_TIME")
    VALUES (1, 'hive', 'Default catalog', 's3a://warehouse/', EXTRACT(EPOCH FROM NOW())::integer)
    ON CONFLICT DO NOTHING;
    
    CREATE TABLE IF NOT EXISTS "DBS" (
      "DB_ID" bigint NOT NULL,
      "DESC" varchar(4000),
      "DB_LOCATION_URI" varchar(4000) NOT NULL,
      "NAME" varchar(128),
      "OWNER_NAME" varchar(128),
      "OWNER_TYPE" varchar(10),
      "CTLG_NAME" varchar(256),
      PRIMARY KEY ("DB_ID")
    );
    
    CREATE SEQUENCE IF NOT EXISTS "DBS_DB_ID_seq";
    
    CREATE TABLE IF NOT EXISTS "TBLS" (
      "TBL_ID" bigint NOT NULL,
      "CREATE_TIME" integer NOT NULL,
      "DB_ID" bigint,
      "LAST_ACCESS_TIME" integer NOT NULL,
      "OWNER" varchar(767),
      "OWNER_TYPE" varchar(10),
      "RETENTION" integer NOT NULL,
      "SD_ID" bigint,
      "TBL_NAME" varchar(256),
      "TBL_TYPE" varchar(128),
      "VIEW_EXPANDED_TEXT" text,
      "VIEW_ORIGINAL_TEXT" text,
      "IS_REWRITE_ENABLED" boolean NOT NULL DEFAULT false,
      "WRITE_ID" bigint NOT NULL DEFAULT 0,
      PRIMARY KEY ("TBL_ID")
    );
    
    CREATE SEQUENCE IF NOT EXISTS "TBLS_TBL_ID_seq";
    
    -- Essential metastore setup complete
    EOF
    
    echo "Hive Metastore schema initialized successfully!"
---
apiVersion: batch/v1
kind: Job
metadata:
  name: hive-schema-init
  namespace: default
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      restartPolicy: OnFailure
      containers:
      - name: init-schema
        image: postgres:16
        command: ["/bin/bash", "/scripts/init-schema.sh"]
        volumeMounts:
        - name: init-script
          mountPath: /scripts
        - name: postgres-secret
          mountPath: /var/run/secrets/postgres-password
          readOnly: true
      volumes:
      - name: init-script
        configMap:
          name: hive-init-script
          defaultMode: 0755
      - name: postgres-secret
        secret:
          secretName: postgres-postgresql
